<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="rating" content="general" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="author" content="Don616">
    <meta name="description" content="Site Tarot">
    <meta name="keywords" content="tarot, arcanos, cards, tarô, oraculo">
    <meta http-equiv="content-language" content="pt-br" />
    <meta name="copyright" content="Don616 © 2021" />
    <link rel="shortcut icon" href="./imagens/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <title>DashBoard</title>
</head>
<body onload=" setDadosDash()">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.6.0/chart.min.js"></script>
    <header id="header">
        <div class="container">
            <div class="logo">
                <h1><a href="./index.html">Site Tarot</a></h1>
            </div>
            <ul class="navbar">

                <li><a href="./sobre.html">Sobre o site</a></li>
                <li><a href="./quemsomos.html">Quem Somos</a></li>
                <li><a href="./login.html">Login</a></li>
                <li><a href="./cadastro.html">Cadastro</a></li>
                
                

            </ul>
        </div>
    </header>
    <header id="header2">
        <div class="container">
            <div class="logo">
                <h1><a href="./index.html">Site Tarot</a></h1>
            </div>
            <ul class="navbar">

                <li><a href="./tiragem.html">Nova Tiragem</a></li>
                <li><a href="./dashboard.html">Dashboard</a></li>
                <li><a onclick="deslogar()" href="#">Logoff</a></li>
                <li><a href="./sobre.html">Todas as Cartas</a></li>
                
                

            </ul>
        </div>
    </header>
    <main>
        <div class="box1">
            <div id="modal" class="modal">
            
                    <div class="carta"><img id="imgmodal" src="./imagens/Toth/1.png" alt=""></div>
                    <div class="conteudo2">
                        <div class="cabeçalho">
                            <div class="titulo"><h1 id="nome_carta">Alguma coisa</h1></div>
                            <div onclick="fecharModal()" id="fechar" class="fechar">X</div>
                        </div>
                        <div id="corpomodal" class="corpomodal">
                            <p id="txt_cards"></p>
                        </div>
                    </div>
                </div>
            <div class="sidebar">

                <div class="user">
                    <h1 id="nome_do_user"></h1>
                </div>
                <div class="box_conteudo">
                    <div class="titulo"><h1>Palavras-Chave</h1></div>
                    <div id="palavras_chave" class="corpo"></div>

                </div>
                <div class="box_conteudo">
                    <div class="titulo"><h1>Cartas Tiradas</h1></div>
                    <div id="corpo_quantidade_cartas" class="corpo"></div>
                </div>
                <div class="box_conteudo">
                    <button onclick="voltarPagina()">Voltar</button>
                </div>

            </div>
            <div id="conteudo1" class="conteudo1">
                <div class="coluna">
                    <div class="titulo"><h1>Mais Sorteada</h1></div>
                    <div id="div_carta_mais_sorteada" class="corpo"><img onclick="abrirModal()" id="carta_sorteada" src="./imagens/Toth/1.png" alt=""></div>
                </div>
                <div class="grafico">
                    <div class="titulo"><h1>Divisão por Naipe</h1></div>
                    <div id="grafico1" class="corpo"><canvas id="myChart"></canvas></div>
                </div>
            </div>

        </div>
        
        <script src="script/header.js"></script>
        <script src="script/dashboard.js"></script>
        <script src="script/modal.js"></script> 
        <script src="script/grafico.js"></script>
        
</body>
</html>
<script>

    var id_user = localStorage.getItem('ID_USUARIO');

    function setDadosDash(){

        
        var NOME_USER = localStorage.getItem('NOME_USUARIO');

        setTimeout(function () {

            if(id_user != undefined){
    
                obterTotalCartas(id_user);
                var total_cartas = localStorage.getItem('quantidadeCartas');
                console.log(total_cartas)

                pegarCartaQueMaisSaiu(id_user);
                var maior_carta = localStorage.getItem('maiorcarta');
                console.log(maior_carta)

                obterKeywords(maior_carta)
                var keywords1 = localStorage.getItem('keywords1');
                var keywords2 = localStorage.getItem('keywords2');
                var keywords3 = localStorage.getItem('keywords3');
                

                obterNaipe(id_user)
                var lista_naipe = localStorage.getItem('naipe');
                console.log(lista_naipe)
            

                nome_do_user.innerHTML = `Olá, ${NOME_USER}!`;
                corpo_quantidade_cartas.innerHTML = `${total_cartas}`;
                palavras_chave.innerHTML = `${keywords1},${keywords2},${keywords3}`;
                carta_sorteada.src = `./imagens/Toth/${maior_carta}.png`;
    
            } else {
    
                alert('Erro no Login. Redirecionando...')
                document.location = './login.html';
    
            }

        }, 1000);

        
    }
    
    function voltarPagina(){
        document.location = './void.html';
    }

    function obterTotalCartas(user) {

        fetch(`/arcanos/totalcartas/${user}`, { cache: 'no-store' }).then(function (response) {
            
            if (response.ok) {
                
                response.json().then(function (resposta) {
                    
                    //console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();
                    localStorage.setItem('quantidadeCartas',resposta[0].quantidade)
                    
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function pegarCartaQueMaisSaiu(id_user) {
        

        fetch(`/arcanos/maiorcarta/${id_user}`, { cache: 'no-store' }).then(function (response) {
            console.log(response);
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    let dado = JSON.stringify(resposta[0]["FK_ARCANOS"]);
                    console.log(JSON.stringify(resposta[0]["FK_ARCANOS"]))
                    resposta.reverse();
                    localStorage.setItem('maiorcarta',dado)
                    
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }
    function obterKeywords(maior_carta) {

        fetch(`/arcanos/keywords/${maior_carta}`, { cache: 'no-store' }).then(function (response) {
            
            if (response.ok) {
                
                response.json().then(function (resposta) {
                    
                    let dado1 = JSON.stringify(resposta[0]["KEY1"]);
                    let dado2 = JSON.stringify(resposta[0]["KEY2"]);
                    let dado3 = JSON.stringify(resposta[0]["KEY3"]);
                    
                    resposta.reverse();
                    localStorage.setItem('keywords1',dado1)
                    localStorage.setItem('keywords2',dado2)
                    localStorage.setItem('keywords3',dado3)
                    
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }
    function obterNaipe(id_user) {

        fetch(`/arcanos/naipe/${id_user}`, { cache: 'no-store' }).then(function (response) {
            
            if (response.ok) {
                
                response.json().then(function (resposta) {
                    
                    //console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    //console.log('Teste de algo: ' + response.naipe);
                    resposta.reverse();
                    localStorage.setItem('naipe',resposta[0].naipe)
                    
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    
</script>
